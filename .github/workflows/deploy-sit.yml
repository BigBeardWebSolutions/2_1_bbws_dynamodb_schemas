# ============================================================================
# SIT DEPLOYMENT WORKFLOW - Deploy with Approval Gate
# ============================================================================
# Purpose: Deploy infrastructure to SIT after manual approval
# Trigger: Manual workflow dispatch
# Environment: SIT only (815856636111 / eu-west-1)
# Approval Required: Yes - manual approval before terraform apply
# ============================================================================

name: Deploy to SIT

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to deploy'
        type: choice
        required: true
        options:
          - dynamodb
      skip_validation:
        description: 'Skip post-deployment validation'
        type: boolean
        required: false
        default: false

# Permissions for OIDC authentication
permissions:
  id-token: write    # Required for AWS OIDC authentication
  contents: read     # Required to checkout code
  actions: read      # Required for artifacts

env:
  AWS_REGION: eu-west-1
  AWS_ACCOUNT_ID: '815856636111'
  ENVIRONMENT: sit
  TF_VERSION: 1.6.0

jobs:
  # --------------------------------------------------------------------------
  # JOB 1: TERRAFORM PLAN
  # --------------------------------------------------------------------------
  plan:
    name: Terraform Plan (SIT)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_SIT }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-plan-sit

      - name: Verify AWS identity
        run: |
          echo "=================================================="
          echo "AWS IDENTITY VERIFICATION - SIT"
          echo "=================================================="
          echo "Account ID: $(aws sts get-caller-identity --query Account --output text)"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "=================================================="

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        working-directory: terraform/dynamodb
        run: |
          terraform init \
            -backend-config="bucket=bbws-terraform-state-sit" \
            -backend-config="key=2_1_bbws_dynamodb_schemas/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=terraform-state-lock-sit" \
            -backend-config="encrypt=true"

      - name: Terraform plan
        id: plan
        working-directory: terraform/dynamodb
        run: |
          terraform plan \
            -var-file=environments/sit.tfvars \
            -input=false \
            -out=tfplan \
            -no-color \
            | tee plan_output.txt

      - name: Display plan summary
        working-directory: terraform/dynamodb
        run: |
          echo "=================================================="
          echo "TERRAFORM PLAN SUMMARY - SIT"
          echo "=================================================="
          grep -E "Plan:|No changes" plan_output.txt || echo "See full plan above"
          echo "=================================================="

      - name: Upload terraform plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-sit-${{ github.run_number }}
          path: terraform/dynamodb/tfplan
          retention-days: 7

  # --------------------------------------------------------------------------
  # JOB 2: MANUAL APPROVAL GATE
  # --------------------------------------------------------------------------
  approval:
    name: Approve SIT Deployment
    runs-on: ubuntu-latest
    needs: plan
    environment:
      name: sit-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Approval checkpoint
        run: |
          echo "=================================================="
          echo "SIT DEPLOYMENT APPROVAL"
          echo "=================================================="
          echo "Environment: SIT"
          echo "Account: ${{ env.AWS_ACCOUNT_ID }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "Deployment approved by: ${{ github.actor }}"
          echo "=================================================="

  # --------------------------------------------------------------------------
  # JOB 3: TERRAFORM APPLY
  # --------------------------------------------------------------------------
  apply:
    name: Deploy to SIT
    runs-on: ubuntu-latest
    needs: approval

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_SIT }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-deploy-sit

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        working-directory: terraform/dynamodb
        run: |
          terraform init \
            -backend-config="bucket=bbws-terraform-state-sit" \
            -backend-config="key=2_1_bbws_dynamodb_schemas/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=terraform-state-lock-sit" \
            -backend-config="encrypt=true"

      - name: Download terraform plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-sit-${{ github.run_number }}
          path: terraform/dynamodb/

      - name: Terraform apply
        working-directory: terraform/dynamodb
        run: |
          echo "Applying terraform plan to SIT..."
          terraform apply -auto-approve tfplan

      - name: Capture terraform outputs
        id: outputs
        working-directory: terraform/dynamodb
        run: |
          echo "=================================================="
          echo "TERRAFORM OUTPUTS - SIT"
          echo "=================================================="
          terraform output -json | tee outputs.json
          terraform output
          echo "=================================================="

      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        with:
          name: dynamodb-deployment-outputs-sit-${{ github.run_number }}
          path: terraform/dynamodb/outputs.json
          retention-days: 90

  # --------------------------------------------------------------------------
  # JOB 4: DEPLOYMENT SUMMARY
  # --------------------------------------------------------------------------
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [plan, approval, apply]
    if: always()

    steps:
      - name: Generate deployment summary
        run: |
          echo "=================================================="
          echo "SIT DEPLOYMENT SUMMARY"
          echo "=================================================="
          echo "Environment: SIT"
          echo "AWS Account: ${{ env.AWS_ACCOUNT_ID }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "Job Results:"
          echo "  Plan: ${{ needs.plan.result }}"
          echo "  Approval: ${{ needs.approval.result }}"
          echo "  Apply: ${{ needs.apply.result }}"
          echo ""
          echo "Workflow Run: ${{ github.run_id }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "=================================================="

          # Check if any job failed
          if [ "${{ needs.plan.result }}" == "failure" ] || \
             [ "${{ needs.approval.result }}" == "failure" ] || \
             [ "${{ needs.apply.result }}" == "failure" ]; then
            echo "❌ DEPLOYMENT FAILED - Check job logs above"
            exit 1
          else
            echo "✅ DEPLOYMENT SUCCESSFUL"
          fi
